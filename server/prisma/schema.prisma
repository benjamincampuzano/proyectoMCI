generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model UserHierarchy {
  id        Int           @id @default(autoincrement())
  parentId  Int
  childId   Int
  role      HierarchyRole
  createdAt DateTime      @default(now()) @db.Timestamptz(6)
  child     User          @relation("HierarchyChild", fields: [childId], references: [id])
  parent    User          @relation("HierarchyParent", fields: [parentId], references: [id])

  @@unique([parentId, childId])
  @@index([role])
}

model User {
  id                      Int                      @id @default(autoincrement())
  email                   String                   @unique
  phone                   String?                  @unique
  password                String
  isActive                Boolean                  @default(true)
  isDeleted               Boolean                  @default(false)
  cellId                  Int?
  createdAt               DateTime                 @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime                 @updatedAt @db.Timestamptz(6)
  mustChangePassword      Boolean                  @default(false)
  auditLogs               AuditLog[]
  hostedCells             Cell[]                   @relation("CellHost")
  ledCells                Cell[]                   @relation("CellLeader")
  doceNetworkCells        Cell[]                   @relation("CellLiderDoce")
  cellAttendances         CellAttendance[]
  churchAttendances       ChurchAttendance[]
  classAttendances        ClassAttendance[]
  coordinatedConventions  Convention[]             @relation("ConventionCoordinator")
  conventionLeaderships   ConventionLeader[]
  registeredConventions   ConventionRegistration[] @relation("ConventionRegistrar")
  conventionRegistrations ConventionRegistration[]
  coordinatedEncuentros   Encuentro[]              @relation("EncuentroCoordinator")
  encuentroLeaderships    EncuentroLeader[]
  encuentroRegistrations  EncuentroRegistration[]
  goals                   Goal[]                   @relation("UserGoals")
  assignedGuests          Guest[]                  @relation("AssignedTo")
  invitedGuests           Guest[]                  @relation("InvitedBy")
  guestCalls              GuestCall[]
  guestVisits             GuestVisit[]
  oracionesLed            OracionDeTres[]          @relation("LiderDoceOracion")
  oracionesMiembro        OracionDeTresMiembro[]
  guidedEnrollments       SeminarEnrollment[]      @relation("AssignedAuxiliar")
  seminarEnrollments      SeminarEnrollment[]
  professedModules        SeminarModule[]          @relation("ModuleProfessor")
  cell                    Cell?                    @relation("CellMembers", fields: [cellId], references: [id])
  parents                 UserHierarchy[]          @relation("HierarchyChild")
  children                UserHierarchy[]          @relation("HierarchyParent")
  profile                 UserProfile?
  roles                   UserRole[]
  auxiliaryModules        SeminarModule[]          @relation("ModuleAuxiliaries")

  @@index([email])
  @@index([createdAt])
}

model UserProfile {
  id                      Int            @id @default(autoincrement())
  userId                  Int            @unique
  fullName                String
  sex                     Sex?
  documentType            DocumentType?
  documentNumber          String?
  birthDate               DateTime?      @db.Timestamptz(6)
  address                 String?
  city                    String?
  latitude                Float?
  longitude               Float?
  dataPolicyAccepted      Boolean        @default(false)
  dataTreatmentAuthorized Boolean        @default(false)
  minorConsentAuthorized  Boolean        @default(false)
  maritalStatus           MaritalStatus?
  network                 Network?
  user                    User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentType, documentNumber])
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique
  permissions RolePermission[]
  users       UserRole[]
}

model Permission {
  id    Int              @id @default(autoincrement())
  key   String           @unique
  roles RolePermission[]
}

model RolePermission {
  roleId       Int
  permissionId Int
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model UserRole {
  userId Int
  roleId Int
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Guest {
  id                      Int                     @id @default(autoincrement())
  name                    String
  phone                   String
  documentType            DocumentType?
  documentNumber          String?
  birthDate               DateTime?               @db.Timestamptz(6)
  sex                     Sex?
  address                 String?
  city                    String?
  prayerRequest           String?
  status                  GuestStatus             @default(NUEVO)
  isDeleted               Boolean                 @default(false)
  called                  Boolean                 @default(false)
  callObservation         String?
  visited                 Boolean                 @default(false)
  visitObservation        String?
  invitedById             Int
  assignedToId            Int?
  createdAt               DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt               DateTime                @updatedAt @db.Timestamptz(6)
  dataPolicyAccepted      Boolean                 @default(false)
  dataTreatmentAuthorized Boolean                 @default(false)
  minorConsentAuthorized  Boolean                 @default(false)
  encuentroRegistrations  EncuentroRegistration[]
  assignedTo              User?                   @relation("AssignedTo", fields: [assignedToId], references: [id])
  invitedBy               User                    @relation("InvitedBy", fields: [invitedById], references: [id])
  calls                   GuestCall[]
  visits                  GuestVisit[]

  @@index([status])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([invitedById])
}

model GuestCall {
  id          Int      @id @default(autoincrement())
  guestId     Int
  date        DateTime @default(now()) @db.Timestamptz(6)
  observation String
  callerId    Int?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  caller      User?    @relation(fields: [callerId], references: [id])
  guest       Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

model GuestVisit {
  id          Int      @id @default(autoincrement())
  guestId     Int
  date        DateTime @default(now()) @db.Timestamptz(6)
  observation String
  visitorId   Int?
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  guest       Guest    @relation(fields: [guestId], references: [id], onDelete: Cascade)
  visitor     User?    @relation(fields: [visitorId], references: [id])
}

model Cell {
  id          Int              @id @default(autoincrement())
  name        String
  description String?
  leaderId    Int
  hostId      Int?
  liderDoceId Int?
  address     String?
  city        String?
  latitude    Float?
  longitude   Float?
  dayOfWeek   String?
  time        String?
  cellType    String           @default("ABIERTA")
  isDeleted   Boolean          @default(false)
  createdAt   DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime         @updatedAt @db.Timestamptz(6)
  host        User?            @relation("CellHost", fields: [hostId], references: [id])
  leader      User             @relation("CellLeader", fields: [leaderId], references: [id])
  liderDoce   User?            @relation("CellLiderDoce", fields: [liderDoceId], references: [id])
  attendances CellAttendance[]
  members     User[]           @relation("CellMembers")

  @@index([leaderId])
  @@index([liderDoceId])
  @@index([hostId])
}

model ChurchAttendance {
  id        Int              @id @default(autoincrement())
  date      DateTime         @db.Timestamptz(6)
  userId    Int
  status    AttendanceStatus @default(PRESENTE)
  createdAt DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @db.Timestamptz(6)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([date, userId])
  @@index([date])
  @@index([createdAt])
  @@index([status])
}

model CellAttendance {
  id        Int              @id @default(autoincrement())
  date      DateTime         @db.Timestamptz(6)
  cellId    Int
  userId    Int
  status    AttendanceStatus @default(PRESENTE)
  createdAt DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt DateTime         @updatedAt @db.Timestamptz(6)
  cell      Cell             @relation(fields: [cellId], references: [id])
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([date, cellId, userId])
  @@index([date])
  @@index([createdAt])
  @@index([status])
}

model SeminarModule {
  id           Int                 @id @default(autoincrement())
  name         String
  description  String?
  moduleNumber Int?
  code         String?             @unique
  type         String              @default("SEMINARIO")
  startDate    DateTime?           @db.Timestamptz(6)
  endDate      DateTime?           @db.Timestamptz(6)
  professorId  Int?
  createdAt    DateTime            @default(now()) @db.Timestamptz(6)
  isDeleted    Boolean             @default(false)
  updatedAt    DateTime            @updatedAt @db.Timestamptz(6)
  materials    ClassMaterial[]
  enrollments  SeminarEnrollment[]
  professor    User?               @relation("ModuleProfessor", fields: [professorId], references: [id])
  auxiliaries  User[]              @relation("ModuleAuxiliaries")
}

model ClassMaterial {
  id          Int             @id @default(autoincrement())
  moduleId    Int
  classNumber Int
  description String?
  createdAt   DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime        @updatedAt @db.Timestamptz(6)
  module      SeminarModule   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  resources   ClassResource[]

  @@unique([moduleId, classNumber])
}

model ClassResource {
  id         Int           @id @default(autoincrement())
  materialId Int
  type       ResourceType
  url        String
  material   ClassMaterial @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@index([type])
}

model SeminarEnrollment {
  id                 Int               @id @default(autoincrement())
  userId             Int
  moduleId           Int
  status             EnrollmentStatus  @default(INSCRITO)
  assignmentsDone    Int               @default(0)
  finalProjectGrade  Float?
  assignedAuxiliarId Int?
  projectNotes       String?
  finalGrade         Float?
  createdAt          DateTime          @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime          @updatedAt @db.Timestamptz(6)
  classAttendances   ClassAttendance[]
  assignedAuxiliar   User?             @relation("AssignedAuxiliar", fields: [assignedAuxiliarId], references: [id])
  module             SeminarModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@index([status])
  @@index([createdAt])
  @@index([moduleId])
  @@index([userId])
}

model ClassAttendance {
  id           Int                   @id @default(autoincrement())
  enrollmentId Int
  userId       Int
  classNumber  Int
  status       ClassAttendanceStatus @default(ASISTE)
  grade        Float?
  notes        String?
  createdAt    DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime              @updatedAt @db.Timestamptz(6)
  enrollment   SeminarEnrollment     @relation(fields: [enrollmentId], references: [id])
  user         User                  @relation(fields: [userId], references: [id])

  @@unique([enrollmentId, classNumber])
}

model Convention {
  id                Int                      @id @default(autoincrement())
  type              ConventionType
  year              Int
  theme             String?
  cost              Float
  transportCost     Float                    @default(0)
  accommodationCost Float                    @default(0)
  startDate         DateTime                 @db.Timestamptz(6)
  endDate           DateTime                 @db.Timestamptz(6)
  isDeleted         Boolean                  @default(false)
  createdAt         DateTime                 @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime                 @updatedAt @db.Timestamptz(6)
  coordinatorId     Int?
  coordinator       User?                    @relation("ConventionCoordinator", fields: [coordinatorId], references: [id])
  leaders           ConventionLeader[]
  registrations     ConventionRegistration[]
  goals             Goal[]

  @@unique([type, year])
  @@index([type])
  @@index([startDate])
}

model ConventionLeader {
  conventionId Int
  userId       Int
  convention   Convention @relation(fields: [conventionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conventionId, userId])
}

model ConventionRegistration {
  id                 Int                 @id @default(autoincrement())
  userId             Int
  conventionId       Int
  status             RegistrationStatus  @default(REGISTERED)
  discountPercentage Float               @default(0)
  needsTransport     Boolean             @default(false)
  needsAccommodation Boolean             @default(false)
  registeredById     Int?
  createdAt          DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @db.Timestamptz(6)
  payments           ConventionPayment[]
  convention         Convention          @relation(fields: [conventionId], references: [id], onDelete: Cascade)
  registeredBy       User?               @relation("ConventionRegistrar", fields: [registeredById], references: [id])
  user               User                @relation(fields: [userId], references: [id])

  @@unique([userId, conventionId])
  @@index([status])
  @@index([createdAt])
}

model ConventionPayment {
  id             Int                    @id @default(autoincrement())
  registrationId Int
  amount         Float
  paymentType    ConventionPaymentType  @default(CONVENTION)
  date           DateTime               @default(now()) @db.Timestamptz(6)
  notes          String?
  createdAt      DateTime               @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime               @updatedAt @db.Timestamptz(6)
  registration   ConventionRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
}

model Encuentro {
  id            Int                     @id @default(autoincrement())
  type          EncuentroType
  name          String
  description   String?
  cost          Float
  startDate     DateTime                @db.Timestamptz(6)
  endDate       DateTime                @db.Timestamptz(6)
  coordinatorId Int?
  isDeleted     Boolean                 @default(false)
  createdAt     DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime                @updatedAt @db.Timestamptz(6)
  coordinator   User?                   @relation("EncuentroCoordinator", fields: [coordinatorId], references: [id])
  leaders       EncuentroLeader[]
  registrations EncuentroRegistration[]
  goals         Goal[]

  @@index([type])
  @@index([startDate])
}

model EncuentroLeader {
  encuentroId Int
  userId      Int
  encuentro   Encuentro @relation(fields: [encuentroId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([encuentroId, userId])
}

model EncuentroRegistration {
  id                 Int                        @id @default(autoincrement())
  guestId            Int?
  userId             Int?
  encuentroId        Int
  status             RegistrationStatus         @default(REGISTERED)
  discountPercentage Float                      @default(0)
  createdAt          DateTime                   @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime                   @updatedAt @db.Timestamptz(6)
  classAttendances   EncuentroClassAttendance[]
  payments           EncuentroPayment[]
  encuentro          Encuentro                  @relation(fields: [encuentroId], references: [id], onDelete: Cascade)
  guest              Guest?                     @relation(fields: [guestId], references: [id], onDelete: Cascade)
  user               User?                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([guestId, encuentroId])
  @@unique([userId, encuentroId])
  @@index([status])
  @@index([createdAt])
}

model EncuentroPayment {
  id             Int                   @id @default(autoincrement())
  registrationId Int
  amount         Float
  date           DateTime              @default(now()) @db.Timestamptz(6)
  notes          String?
  createdAt      DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime              @updatedAt @db.Timestamptz(6)
  registration   EncuentroRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
}

model EncuentroClassAttendance {
  id             Int                   @id @default(autoincrement())
  registrationId Int
  classNumber    Int
  attended       Boolean               @default(false)
  date           DateTime              @default(now()) @db.Timestamptz(6)
  createdAt      DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime              @updatedAt @db.Timestamptz(6)
  registration   EncuentroRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@unique([registrationId, classNumber])
}

model AuditLog {
  id         Int         @id @default(autoincrement())
  userId     Int?
  action     AuditAction
  entityType EntityType
  entityId   Int?
  details    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now()) @db.Timestamptz(6)
  user       User?       @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

model Goal {
  id           Int         @id @default(autoincrement())
  type         GoalType
  targetValue  Float
  encuentroId  Int?
  conventionId Int?
  month        Int?
  year         Int?
  userId       Int?
  createdAt    DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime    @updatedAt @db.Timestamptz(6)
  convention   Convention? @relation(fields: [conventionId], references: [id])
  encuentro    Encuentro?  @relation(fields: [encuentroId], references: [id])
  user         User?       @relation("UserGoals", fields: [userId], references: [id])
}

model OracionDeTres {
  id          Int                    @id @default(autoincrement())
  liderDoceId Int
  fechaInicio DateTime               @db.Timestamptz(6)
  fechaFin    DateTime               @db.Timestamptz(6)
  estado      OracionDeTresStatus    @default(ACTIVO)
  createdAt   DateTime               @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime               @updatedAt @db.Timestamptz(6)
  liderDoce   User                   @relation("LiderDoceOracion", fields: [liderDoceId], references: [id])
  miembros    OracionDeTresMiembro[]
  personas    OracionDeTresPersona[]
  reuniones   OracionDeTresReunion[]

  @@index([liderDoceId])
  @@index([estado])
}

model OracionDeTresMiembro {
  id              Int           @id @default(autoincrement())
  oracionDeTresId Int
  discipuloId     Int
  discipulo       User          @relation(fields: [discipuloId], references: [id])
  oracionDeTres   OracionDeTres @relation(fields: [oracionDeTresId], references: [id], onDelete: Cascade)

  @@unique([oracionDeTresId, discipuloId])
}

model OracionDeTresPersona {
  id              Int           @id @default(autoincrement())
  oracionDeTresId Int
  nombre          String
  telefono        String
  oracionDeTres   OracionDeTres @relation(fields: [oracionDeTresId], references: [id], onDelete: Cascade)
}

model OracionDeTresReunion {
  id              Int           @id @default(autoincrement())
  oracionDeTresId Int
  fecha           DateTime      @db.Date
  hora            String
  createdAt       DateTime      @default(now()) @db.Timestamptz(6)
  oracionDeTres   OracionDeTres @relation(fields: [oracionDeTresId], references: [id], onDelete: Cascade)

  @@index([oracionDeTresId])
}

model LegalDocument {
  id        Int      @id @default(autoincrement())
  name      String
  url       String
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
}

enum HierarchyRole {
  PASTOR
  LIDER_DOCE
  LIDER_CELULA
  DISCIPULO
  MIEMBRO
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  CONSOLIDATE
}

enum EntityType {
  USER
  GUEST
  CELL
  CONVENTION
  ENCUENTRO
  CLASS
  GOAL
  ENCUENTRO_REGISTRATION
  CONVENTION_REGISTRATION
  ENCUENTRO_PAYMENT
  CONVENTION_PAYMENT
  ENCUENTRO_ATTENDANCE
  ORACION_DE_TRES
  GUEST_CALL
  GUEST_VISIT
  DOCUMENT
}

enum ResourceType {
  DOCUMENT
  VIDEO
  QUIZ
}

enum Sex {
  HOMBRE
  MUJER
}

enum DocumentType {
  RC
  TI
  CC
  CE
  PP
  PEP
}

enum MaritalStatus {
  SOLTERO
  CASADO
  DIVORCIADO
  VIUDO
  UNION_LIBRE
  SEPARADO
}

enum Network {
  MUJERES
  HOMBRES
  JOVENES
  KIDS
  ROCAS
}

enum GuestStatus {
  NUEVO
  CONTACTADO
  CONSOLIDADO
  GANADO
}

enum AttendanceStatus {
  PRESENTE
  AUSENTE
}

enum ClassAttendanceStatus {
  ASISTE
  AUSENCIA_JUSTIFICADA
  AUSENCIA_NO_JUSTIFICADA
  BAJA
}

enum EnrollmentStatus {
  INSCRITO
  EN_PROGRESO
  COMPLETADO
  ABANDONADO
}

enum ConventionType {
  FAMILIAS
  MUJERES
  JOVENES
  HOMBRES
}

enum RegistrationStatus {
  REGISTERED
  CANCELLED
  ATTENDED
}

enum ConventionPaymentType {
  CONVENTION
  TRANSPORT
  ACCOMMODATION
}

enum EncuentroType {
  MUJERES
  HOMBRES
  JOVENES
}

enum GoalType {
  ENCUENTRO_REGISTRATIONS
  ENCUENTRO_CONVERSIONS
  CONVENTION_REGISTRATIONS
  CELL_COUNT
  CELL_ATTENDANCE
}

enum OracionDeTresStatus {
  ACTIVO
  FINALIZADO
}
